<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>计量证书防伪溯源系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f9fafb; }
    .card { @apply bg-white shadow-md rounded-xl p-6 mb-6; }
    .btn { @apply bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg; }
    .input { @apply border border-gray-300 rounded-lg px-3 py-2 w-full; }
  </style>
</head>
<body class="max-w-4xl mx-auto p-6">

  <!-- 登录模块 -->
  <div id="login-section" class="card">
    <h2 class="text-xl font-bold mb-4">用户登录</h2>
    <input id="username" type="text" placeholder="用户名" class="input mb-2">
    <input id="password" type="password" placeholder="密码" class="input mb-4">
    <button onclick="login()" class="btn">登录</button>
    <p id="login-status" class="mt-3 text-sm text-gray-600"></p>
  </div>

  <!-- 证书管理 -->
  <div id="cert-section" class="card hidden">
    <h2 class="text-xl font-bold mb-4">证书管理</h2>
    <div class="flex space-x-2 mb-4">
      <input id="certNumber" type="text" placeholder="证书编号" class="input flex-1">
      <button onclick="createCertificate()" class="btn">创建证书</button>
    </div>
    <button onclick="getCertificates()" class="btn mb-4">获取所有证书</button>
    <div id="cert-list" class="space-y-2"></div>
  </div>

  <!-- 测试数据管理 -->
  <div id="data-section" class="card hidden">
    <h2 class="text-xl font-bold mb-4">测试数据管理</h2>
    <input id="data-cert-number" type="text" placeholder="证书编号" class="input mb-2">
    <textarea id="test-data-json" class="input h-32 mb-2" placeholder='输入测试数据 JSON 数组，如：
[
  {
    "deviceAddr": "DEV-01",
    "testPoint": "P1",
    "actualPercentage": 100,
    "ratioError": 0.2,
    "angleError": 0.1,
    "testTimestamp": "2023-10-26T10:00:00Z"
  }
]' ></textarea>
    <button onclick="addTestData()" class="btn mb-4">批量添加测试数据</button>
    <div>
      <button onclick="getTestData()" class="btn">获取测试数据</button>
    </div>
    <pre id="test-data-output" class="bg-gray-100 p-3 mt-3 rounded-lg overflow-x-auto"></pre>
  </div>

  <script>
    const API_BASE = "http://192.168.85.129:8080/api/v1";
    let token = "";

    async function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const resp = await fetch(`${API_BASE}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await resp.json();
      if (data.code === 200 && data.data.token) {
        token = data.data.token;
        document.getElementById("login-status").innerText = "✅ 登录成功";
        document.getElementById("cert-section").classList.remove("hidden");
        document.getElementById("data-section").classList.remove("hidden");
      } else {
        document.getElementById("login-status").innerText = "❌ 登录失败: " + JSON.stringify(data);
      }
    }

    async function createCertificate() {
      const certNumber = document.getElementById("certNumber").value;
      const resp = await fetch(`${API_BASE}/certificates`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          certNumber,
          customerId: 1,
          instrumentName: "万用表",
          instrumentNumber: "MTR-12345",
          manufacturer: "XYZ Corp",
          modelSpec: "Model A",
          instrumentAccuracy: "0.1%",
          testDate: "2023-10-26",
          expireDate: "2025-10-26",
          testResult: "qualified"
        })
      });
      const data = await resp.json();
      alert("创建证书结果: " + JSON.stringify(data));
    }

    async function getCertificates() {
      const resp = await fetch(`${API_BASE}/certificates`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await resp.json();
      document.getElementById("cert-list").innerHTML = 
        data.data.map(c => `<div class="p-2 border rounded">📜 ${c.certNumber}</div>`).join("");
    }

    async function addTestData() {
      const certNumber = document.getElementById("data-cert-number").value;
      const rawJson = document.getElementById("test-data-json").value;
      let dataArr;
      try {
        dataArr = JSON.parse(rawJson);
      } catch (e) {
        alert("JSON 格式错误");
        return;
      }

      const resp = await fetch(`${API_BASE}/test-data`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ certNumber, data: dataArr })
      });

      const data = await resp.json();
      alert("添加测试数据结果: " + JSON.stringify(data));
    }

    async function getTestData() {
      const certNumber = document.getElementById("data-cert-number").value;
      const resp = await fetch(`${API_BASE}/test-data/certificate/${certNumber}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await resp.json();
      document.getElementById("test-data-output").innerText = JSON.stringify(data, null, 2);
    }
  </script>
</body>
</html>
