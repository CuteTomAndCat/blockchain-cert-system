<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>è®¡é‡è¯ä¹¦é˜²ä¼ªæº¯æºç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f9fafb; }
    .card { @apply bg-white shadow-md rounded-xl p-6 mb-6; }
    .btn { @apply bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg; }
    .input { @apply border border-gray-300 rounded-lg px-3 py-2 w-full; }
  </style>
</head>
<body class="max-w-4xl mx-auto p-6">

  <!-- ç™»å½•æ¨¡å— -->
  <div id="login-section" class="card">
    <h2 class="text-xl font-bold mb-4">ç”¨æˆ·ç™»å½•</h2>
    <input id="username" type="text" placeholder="ç”¨æˆ·å" class="input mb-2">
    <input id="password" type="password" placeholder="å¯†ç " class="input mb-4">
    <button onclick="login()" class="btn">ç™»å½•</button>
    <p id="login-status" class="mt-3 text-sm text-gray-600"></p>
  </div>

  <!-- è¯ä¹¦ç®¡ç† -->
  <div id="cert-section" class="card hidden">
    <h2 class="text-xl font-bold mb-4">è¯ä¹¦ç®¡ç†</h2>
    <div class="flex space-x-2 mb-4">
      <input id="certNumber" type="text" placeholder="è¯ä¹¦ç¼–å·" class="input flex-1">
      <button onclick="createCertificate()" class="btn">åˆ›å»ºè¯ä¹¦</button>
    </div>
    <button onclick="getCertificates()" class="btn mb-4">è·å–æ‰€æœ‰è¯ä¹¦</button>
    <div id="cert-list" class="space-y-2"></div>
  </div>

  <!-- æµ‹è¯•æ•°æ®ç®¡ç† -->
  <div id="data-section" class="card hidden">
    <h2 class="text-xl font-bold mb-4">æµ‹è¯•æ•°æ®ç®¡ç†</h2>
    <input id="data-cert-number" type="text" placeholder="è¯ä¹¦ç¼–å·" class="input mb-2">
    <textarea id="test-data-json" class="input h-32 mb-2" placeholder='è¾“å…¥æµ‹è¯•æ•°æ® JSON æ•°ç»„ï¼Œå¦‚ï¼š
[
  {
    "deviceAddr": "DEV-01",
    "testPoint": "P1",
    "actualPercentage": 100,
    "ratioError": 0.2,
    "angleError": 0.1,
    "testTimestamp": "2023-10-26T10:00:00Z"
  }
]' ></textarea>
    <button onclick="addTestData()" class="btn mb-4">æ‰¹é‡æ·»åŠ æµ‹è¯•æ•°æ®</button>
    <div>
      <button onclick="getTestData()" class="btn">è·å–æµ‹è¯•æ•°æ®</button>
    </div>
    <pre id="test-data-output" class="bg-gray-100 p-3 mt-3 rounded-lg overflow-x-auto"></pre>
  </div>

  <script>
    const API_BASE = "http://192.168.85.129:8080/api/v1";
    let token = "";

    async function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const resp = await fetch(`${API_BASE}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });

      const data = await resp.json();
      if (data.code === 200 && data.data.token) {
        token = data.data.token;
        document.getElementById("login-status").innerText = "âœ… ç™»å½•æˆåŠŸ";
        document.getElementById("cert-section").classList.remove("hidden");
        document.getElementById("data-section").classList.remove("hidden");
      } else {
        document.getElementById("login-status").innerText = "âŒ ç™»å½•å¤±è´¥: " + JSON.stringify(data);
      }
    }

    async function createCertificate() {
      const certNumber = document.getElementById("certNumber").value;
      const resp = await fetch(`${API_BASE}/certificates`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          certNumber,
          customerId: 1,
          instrumentName: "ä¸‡ç”¨è¡¨",
          instrumentNumber: "MTR-12345",
          manufacturer: "XYZ Corp",
          modelSpec: "Model A",
          instrumentAccuracy: "0.1%",
          testDate: "2023-10-26",
          expireDate: "2025-10-26",
          testResult: "qualified"
        })
      });
      const data = await resp.json();
      alert("åˆ›å»ºè¯ä¹¦ç»“æœ: " + JSON.stringify(data));
    }

    async function getCertificates() {
      const resp = await fetch(`${API_BASE}/certificates`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await resp.json();
      document.getElementById("cert-list").innerHTML = 
        data.data.map(c => `<div class="p-2 border rounded">ğŸ“œ ${c.certNumber}</div>`).join("");
    }

    async function addTestData() {
      const certNumber = document.getElementById("data-cert-number").value;
      const rawJson = document.getElementById("test-data-json").value;
      let dataArr;
      try {
        dataArr = JSON.parse(rawJson);
      } catch (e) {
        alert("JSON æ ¼å¼é”™è¯¯");
        return;
      }

      const resp = await fetch(`${API_BASE}/test-data`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ certNumber, data: dataArr })
      });

      const data = await resp.json();
      alert("æ·»åŠ æµ‹è¯•æ•°æ®ç»“æœ: " + JSON.stringify(data));
    }

    async function getTestData() {
      const certNumber = document.getElementById("data-cert-number").value;
      const resp = await fetch(`${API_BASE}/test-data/certificate/${certNumber}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const data = await resp.json();
      document.getElementById("test-data-output").innerText = JSON.stringify(data, null, 2);
    }
  </script>
</body>
</html>
